    # /agents/advice_agent.py

import json
from clients.llm_client import LLMClient

class InvestmentAdviceAgent:
    """
    최종 선택된 알파 팩터를 기반으로 사용자 친화적인 투자 조언 리포트를 생성하는 에이전트.
    """
    def __init__(self, llm_client: LLMClient):
        """
        에이전트를 초기화합니다.

        Args:
            llm_client (LLMClient): LLM과 상호작용하기 위한 클라이언트.
        """
        self.llm_client = llm_client

    def generate_advice_report(self, best_factor: dict) -> str:
        """
        최고 성과 팩터 정보를 바탕으로 투자 조언 리포트를 생성합니다.

        Args:
            best_factor (dict): 최고 성과 팩터 정보.
                                (키: 'description', 'formula')

        Returns:
            str: Markdown 형식으로 생성된 투자 조언 리포트.
        """
        system_prompt = """
        당신은 개인 투자자를 위한 전문적이고 통찰력 있는 퀀트 투자 자문가입니다.
        복잡한 금융 데이터와 알파 팩터를 분석하여, 데이터에 기반한 실행 가능한 투자 전략을 제시하는 데 특화되어 있습니다.
        당신의 조언은 항상 명확한 근거와 논리를 바탕으로 하며, 잠재적 위험까지 투명하게 공개하여 투자자가 합리적인 의사결정을 내리도록 돕습니다.

        제시된 알파 팩터를 분석하여, 다음 목차와 세부 가이드에 따라 전문가 수준의 '투자 조언 리포트'를 Markdown 형식으로 작성해주세요.

        <투자 조언 리포트>
        1. 알파 팩터 소개
        2. 투자 전략 설계
        """

        user_prompt = f"""
        다음은 새롭게 발굴된 우수한 알파 팩터의 정보입니다. 이 정보를 바탕으로 '투자 조언 리포트'를 작성해주세요.

        - 팩터 설명: {best_factor.get('description', 'N/A')}
        - 팩터 수식: `{best_factor.get('formula', 'N/A')}`

        리포트 작성 가이드:

        ### **1. 알파 팩터 소개**

        이 섹션에서는 팩터의 본질과 투자 철학을 깊이 있게 다룹니다.

        -   **팩터의 정의:**
            -   팩터의 핵심 아이디어를 반영하는 직관적인 이름(예: '고품질 저평가 팩터')을 제안해주세요.
            -   팩터 수식을 명시하고, 각 변수(예: PBR, ROE, 모멘텀)가 의미하는 바를 간략히 설명해주세요.
        -   **팩터의 직관적 해석:**
            -   이 수식이 **왜 유효한가**에 대한 논리적 근거를 제시해주세요. 일반 투자자가 이해할 수 있도록 "이 팩터는 단순히 싼 주식이 아니라, **수익성까지 좋아서 억울하게 저평가된 기업**을 찾아냅니다."와 같이 비유를 들어 설명해주세요.
        -   **투자 철학적 배경:**
            -   이 팩터가 어떤 주류 투자 철학(예: 벤저민 그레이엄의 가치투자, 피터 린치의 성장주 투자)에 뿌리를 두고 있는지 연결하여 설명해주세요. 이는 팩터의 신뢰도를 높여줍니다.
        -   **팩터가 효과적인 시장 상황:**
            -   이 팩터가 어떤 시장 국면(예: 횡보장, 금리 인상기, 경기 침체기)에서 특히 강점을 보일 것으로 예상되는지 분석해주세요.

        ### **2. 투자 전략 설계 (Strategy Design)**

        이 섹션에서는 팩터를 실제 투자에 적용하기 위한 구체적인 청사진을 제시합니다.

        -   **포트폴리오 구성 방안:**
            -   **투자 유니버스:** 어떤 시장(예: KOSPI 200, S&P 500)의 종목들을 대상으로 할지 명시해주세요.
            -   **매매 전략:** 팩터 점수가 높은 상위 N%의 종목을 매수하는 '롱 온리(Long-only)' 전략인지, 또는 상위 종목 매수와 하위 종목 공매도를 병행하는 '롱숏(Long-short)' 전략인지 제안해주세요. (주로 개인 투자자에게는 '롱 온리'를 추천합니다.)
        -   **권장 투자 스타일 및 기간:**
            -   **투자 기간:** 단기(3개월 미만), 중기(3개월~1년), 장기(1년 이상) 중 어떤 투자 기간에 가장 적합한지 명시해주세요.
            -   **리밸런싱 주기:** 포트폴리오를 재조정해야 하는 주기(예: 월간, 분기별, 반기별)를 구체적으로 제시하고, 그 이유를 설명해주세요. (예: "분기별 리밸런싱을 통해 최신 재무 정보를 전략에 반영하고, 잦은 매매로 인한 거래 비용 증가는 방지합니다.")
        -   **주요 리스크 및 한계점 분석:**
            -   **내재적 한계:** 이 팩터가 포착하지 못하는 것은 무엇인지 설명해주세요. (예: "이 팩터는 미래의 폭발적 성장 잠재력보다는 현재의 재무 건전성에 집중하므로, 혁신 기술을 가진 초기 단계의 성장주는 놓칠 수 있습니다.")
            -   **위험 시나리오:** 어떤 시장 상황에서 이 전략이 저조한 성과를 보일 수 있는지 구체적인 시나리오를 제시해주세요. (예: "모든 주식이 펀더멘털과 무관하게 급등하는 유동성 장세에서는, 본 전략이 시장 수익률을 하회할 수 있습니다.")
        -   **투자 유의사항:**
            -   "본 리포트는 투자 판단을 돕기 위한 정보 제공을 목적으로 하며, 특정 종목의 매수/매도를 추천하는 것이 아닙니다." 와 같은 면책 조항을 포함합니다.
            -   과거 데이터에 기반한 분석이며, 미래 수익을 보장하지 않는다는 점을 명확히 고지합니다.
        """

        report = self.llm_client.generate_text(user_prompt, system_prompt)
        return report
